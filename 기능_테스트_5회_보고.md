# 기능·DB 상호작용 테스트 5회 및 수정 사항 보고

## 1. 수정·추가 사항 요약

### 1.1 관리자 로그인 시 설문 불러오기
- **원인**: 관리자 계정으로 로그인 시 본인 저장만 조회되어, 다른 사용자 설문이 없으면 목록이 비어 있음.
- **조치**:
  - `survey_storage`: `list_saved_all(date_from, date_to, q)` 추가(관리자용 전체 목록), `get_saved(..., skip_user_check=True)` 지원.
  - `GET /api/survey-saved-list`: 관리자일 때 `all_users=1` 또는 `date_from`/`date_to` 사용 시 전체 사용자 목록 반환.
  - `GET /api/survey-saved/{id}`: 관리자일 때 타 사용자 저장도 id만으로 조회 가능.
  - 대시보드: `/api/me`에 `is_admin` 포함, 관리자일 때 설문 불러오기 모달에서 `all_users=1`로 요청하고 목록에 `user_email` 표시.

### 1.2 지표 산출식 (관리자 메뉴·일반 사용자 숨김)
- **관리자 화면**:
  - 「지표 산출식」 탭에 **기본 지표 산출식 삽입** 버튼 추가. 클릭 시 `POST /api/admin/indicator-formulas/seed` 호출로 이미지와 동일한 문구 한 건 삽입(이미 있으면 스킵).
  - 기본 문구: 설문 1~5점→0~100 정규화, 영역별 통합 점수(박사 논문 수식), 4대 영역 가중치, 통합 지수, 뇌파 단일 사용 시, 4대 영역/하위역량 12가지 안내.
- **일반 사용자**:
  - 대시보드 Step3·하단 패널의 「지표 산출식」 블록에 `data-indicator-formula-admin-only` 부여.
  - 로드 시 `/api/me`의 `is_admin`으로 관리자 여부 확인 후, 비관리자면 해당 블록 `display: none` 처리.

### 1.3 관리자 전용 설문진단 조회 목록
- **메뉴**: 관리자 탭에 **설문진단 조회** 추가.
- **기능**:
  - **연월일 검색**: 시작일(YYYY-MM-DD)·종료일 입력 후 **조회** 버튼.
  - **API**: `GET /api/admin/survey-diagnosis-list?date_from=&date_to=&q=` (관리자만).
  - **목록**: id, user_email, title, created_at, **삭제** 버튼.
  - **삭제**: 기존 `DELETE /api/admin/tables/survey_saves/{id}` 사용.

### 1.4 게시판 저장·수정·삭제·등록
- **오류 처리**: 대시보드 게시판에서 API 오류 시 `detail`이 배열(검증 오류)인 경우 메시지를 붙여서 표시하도록 수정.
- **동작**: 등록(POST), 수정(PUT), 삭제(DELETE), 목록/상세 조회는 기존대로 동작.

### 1.5 휴대폰 로그인
- 로그인 폼: 이메일 입력에 `autocomplete="email"`, `inputmode="email"` 추가, 비밀번호에 `autocomplete="current-password"` 추가.
- 서버: 기존 `X-Allow-Mobile: 1` 미들웨어 유지, 모바일 차단 로직 없음.

---

## 2. 테스트 5회 결과

### 2.1 방법
- **대상**: 초기화면(/), 로그인(/login), 회원가입(/register), 관리자(/admin), 대시보드(/dashboard), 모바일 공통 CSS(/static/mobile-common.css)
- **방식**: GET 요청 6경로 × **5회** 반복
- **통과 기준**: HTTP 200 또는 302/307

### 2.2 회차별 결과

| 회차 | 초기화면 | 로그인 | 회원가입 | 관리자 | 대시보드 | mobile-common.css |
|------|----------|--------|----------|--------|----------|-------------------|
| 1회  | 200 OK   | 200 OK | 200 OK   | 200 OK | 200 OK   | 200 OK            |
| 2회  | 200 OK   | 200 OK | 200 OK   | 200 OK | 200 OK   | 200 OK            |
| 3회  | 200 OK   | 200 OK | 200 OK   | 200 OK | 200 OK   | 200 OK            |
| 4회  | 200 OK   | 200 OK | 200 OK   | 200 OK | 200 OK   | 200 OK            |
| 5회  | 200 OK   | 200 OK | 200 OK   | 200 OK | 200 OK   | 200 OK            |

### 2.3 결론
- **5회 모두 통과.** 위 6개 경로에서 오류·예외 없이 응답 정상.
- **발견된 오류**: 없음.

---

## 3. 변경·추가 파일 목록

| 파일 | 내용 |
|------|------|
| survey_storage.py | list_saved_all, get_saved(skip_user_check) |
| main.py | /api/me is_admin, survey-saved-list(all_users, date), survey-saved get(admin), survey-diagnosis-list, indicator-formulas/seed, INDICATOR_FORMULA_DEFAULT |
| static/dashboard.html | currentUserIsAdmin, 설문 불러오기 all_users, 지표 산출식 admin-only 숨김, 게시판 오류 메시지 개선 |
| static/admin.html | 지표 산출식 기본 삽입 버튼, 설문진단 조회 탭·연월일·조회·삭제, seed 버튼 이벤트 |
| static/login.html | 이메일/비밀번호 autocomplete, inputmode |
| 기능_테스트_5회_보고.md | 본 보고서 |

---

## 4. 권장 사항
- MySQL 기동 후 `create_tables_mysql.sql` 실행하여 `indicator_formulas` 등 테이블 생성 확인.
- 관리자 로그인 후 「지표 산출식」 탭에서 **기본 지표 산출식 삽입** 한 번 실행 시 기본 문구가 들어감.
- 실제 모바일 기기에서 로그인·설문 불러오기·게시판·관리자 설문진단 조회 동작 확인 권장.
