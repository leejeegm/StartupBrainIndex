# 배포 전 단계별 체크리스트 (Render 무료 계정 기준)

## 1단계: 데이터 영속화 (재배포 시 초기화 방지)

### 1-1. Render PostgreSQL 생성 (무료)

1. [Render 대시보드](https://dashboard.render.com) 로그인
2. **New +** → **PostgreSQL** 선택
3. **Name**: 예) `sbi-db`
4. **Database**: 무료 플랜 선택
5. **Region**: Web Service와 동일 리전 권장 (예: Singapore)
6. **Create PostgreSQL** 클릭
7. 생성 후 **Info** 탭에서 **Internal Database URL** 복사  
   (형식: `postgresql://user:password@hostname/dbname`)

### 1-2. Web Service에 DB 연결

1. **Dashboard** → 사용 중인 **Web Service**(SBI 앱) 클릭
2. **Environment** 탭 이동
3. **Add Environment Variable** 클릭 후 아래 추가:

| Key | Value |
|-----|--------|
| `DB_ENGINE` | `postgres` |
| `DATABASE_URL` | (1-1에서 복사한 Internal Database URL 붙여넣기) |

4. **Save Changes** 클릭  
   → 저장 시 자동 재배포되거나, **Manual Deploy** → **Deploy latest commit** 실행

### 1-3. (선택) 같은 프로젝트에서 PostgreSQL 연결

- Render에서 **같은 계정·같은 프로젝트**로 PostgreSQL을 만들었다면, Web Service 설정에서 **Connect**로 해당 DB를 연결할 수 있음
- 연결 시 **DATABASE_URL**이 자동으로 들어가는 경우가 있으면, **DB_ENGINE**만 `postgres`로 추가하면 됨

---

## 2단계: 필수 환경 변수 확인

Web Service **Environment**에서 아래가 설정돼 있는지 확인합니다.

| Key | 필수 | 비고 |
|-----|------|------|
| `DB_ENGINE` | ✅ | `postgres` (권장) 또는 `sqlite` |
| `DATABASE_URL` | ✅ (postgres일 때) | 1-1에서 복사한 URL |
| `SESSION_SECRET` | ✅ 권장 | 랜덤 문자열 (미설정 시 재시작마다 세션 초기화) |
| `OPENAI_API_KEY` | 선택 | Step 4 AI 상담 사용 시 |
| `PORT` | 자동 | Render가 지정, 직접 넣지 않아도 됨 |

**SESSION_SECRET 생성 예시** (로컬 터미널):
```bash
python -c "import secrets; print(secrets.token_hex(32))"
```
→ 나온 값을 복사해 `SESSION_SECRET` 값으로 넣기

---

## 3단계: 배포 전 로컬 점검 (선택)

1. **의존성**
   ```bash
   pip install -r requirements.txt
   ```
2. **PostgreSQL 로컬 테스트** (로컬에 Postgres 있으면)
   - `.env`에 `DB_ENGINE=postgres`, `DATABASE_URL=...` 설정
   - `uvicorn main:app --reload` 실행 후 로그인·가입·저장 동작 확인
3. **푸시**
   ```bash
   git add .
   git commit -m "메시지"
   git push origin main
   ```

---

## 4단계: 배포 후 확인

1. **Render Dashboard** → 해당 Web Service → **Logs** 탭
   - 빌드·시작 로그에 에러 없는지 확인
2. **브라우저**에서 서비스 URL 접속
   - 로그인, 회원가입, 설문 저장, AI 상담 저장 등 1회씩 동작 확인
3. **재배포 테스트** (데이터 유지 확인)
   - **Manual Deploy** → **Clear build cache & deploy** 또는 새 커밋 푸시로 재배포
   - 재접속 후 동일 계정 로그인·저장된 데이터 노출 여부 확인

---

## 5단계: SQLite 사용 시 (DB_ENGINE=sqlite)

- 재배포 시 데이터가 초기화됩니다.
- **배포 전**: 관리자 로그인 → **배포 전 데이터 백업** → `.db` 파일 다운로드
- **재배포 후**: 관리자 로그인 → **기존 데이터 불러오기** → 위 파일 업로드 후 복원

장기적으로는 **1단계(PostgreSQL)** 적용을 권장합니다.

---

## 요약

| 순서 | 내용 |
|------|------|
| 1 | Render에서 PostgreSQL 생성 후 Internal Database URL 복사 |
| 2 | Web Service Environment에 `DB_ENGINE=postgres`, `DATABASE_URL=URL` 추가 |
| 3 | `SESSION_SECRET` 설정 (권장) |
| 4 | Save 후 재배포 |
| 5 | 로그인·가입·저장 동작 및 재배포 후 데이터 유지 확인 |

이 체크리스트를 따르면 무료 계정으로도 재배포 시 회원·프로필·저장 데이터가 유지됩니다.
