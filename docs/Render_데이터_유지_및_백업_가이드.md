# Render 재배포 시 데이터 유지 및 백업 가이드

재배포·업그레이드 후에도 **기존 데이터가 유지**되도록 하고, **닷홈(leejee5.dothome.co.kr) 연동**·**SQLite 이전**·**실시간 백업** 옵션을 정리한 문서입니다.

---

## 1. 재배포 시 데이터가 사라지는 이유

- Render **무료 플랜**은 **휘발성 디스크**를 사용합니다.
- 재배포·재시작 시 컨테이너가 새로 만들어지며, 그 안에 있던 **SQLite 파일(sbi.db)** 은 삭제됩니다.
- 따라서 **데이터를 서버 디스크에만 두면 재배포 시 유지되지 않습니다.**

---

## 2. 데이터 유지: 외부 DB 사용 (권장)

앱은 **Render**에서 돌리되, **DB만 외부**에 두면 재배포와 무관하게 데이터가 유지됩니다.

### 2.1 닷홈 MySQL 연동 (leejee5.dothome.co.kr)

**가능 여부**: 닷홈 MySQL이 **원격 접속(외부 IP)** 을 허용하면 연동 가능합니다.  
(일부 무료 호스팅은 `localhost`만 허용해, Render 서버 IP에서 접속이 막힐 수 있습니다.)

**Render 환경 변수** (Dashboard → Environment):

| Key | Value |
|-----|-------|
| `DB_ENGINE` | `mysql` |
| `DB_HOST` | 닷홈 MySQL 호스트 (예: `localhost`는 불가, **닷홈에서 안내하는 MySQL 서버 주소** 사용) |
| `DB_USER` | `leejee5` |
| `DB_PASSWORD` | 닷홈 MySQL 비밀번호 |
| `DB_NAME` | `leejee5` |

- `DB_HOST`: 닷홈이 “원격 접속 가능”하다고 하면 보통 `leejee5.dothome.co.kr` 또는 별도 MySQL 도메인을 안내합니다. **호스팅 제어판·DB 설정**에서 확인하세요.
- 닷홈에서 **외부 접속 허용**이 없으면 Render → 닷홈 MySQL 연동은 **불가**입니다. 아래 다른 DB(관리형 PostgreSQL 등)를 쓰면 됩니다.

**정리**:  
- 닷홈 MySQL 원격 접속 가능 → Render에 위 환경 변수만 넣으면 **재배포해도 데이터 유지**, 닷홈과 연동됩니다.  
- 원격 접속 불가 → 아래 “다른 외부 DB” 사용.

---

## 3. SQLite 기존 데이터 → 재배포 후에도 쓰는 방법

**목표**: 지금까지 쌓은 SQLite(sbi.db) 데이터를 “재배포 후에도” 쓰고 싶은 경우.

### 3.1 한 번만: SQLite → MySQL 이전 (권장)

1. **닷홈 MySQL** (또는 다른 외부 MySQL/PostgreSQL) 에 `create_tables_mysql.sql` 로 테이블 생성.
2. **로컬**에서 SQLite 데이터를 읽어서 MySQL에 넣는 **이전 스크립트** 1회 실행.
   - 예: `users`, `survey_saves`, `chat_saves`, `board`, `eeg_saves`, `indicator_formulas` 테이블별로 `INSERT` 생성 후 MySQL에서 실행.
3. 이후 Render는 **DB_ENGINE=mysql** + 위 환경 변수로만 사용.
4. **재배포할 때마다** “데이터 로딩”을 할 필요 없음. DB가 외부에 있으므로 **항상 그 데이터**를 쓰게 됩니다.

즉, “재배포 시 먼저 데이터 로딩 후 추가”가 아니라, **한 번 MySQL로 이전해 두고, 재배포 후에는 그냥 그 MySQL을 쓰면** 자동으로 기존 데이터가 유지됩니다.

### 3.2 Render에서 SQLite를 계속 쓰는 경우 (비권장)

- Render **유료 Persistent Disk**를 쓰면, 재배포 시에도 디스크가 유지될 수 있습니다. (비용 발생, 백업은 따로 필요.)
- 무료 플랜에서는 **SQLite 파일을 재배포 후 복구**하려면, 매번 **백업에서 복원**하는 별도 절차가 필요해 복잡하고 비추입니다.

---

## 4. 실시간 백업(로그인·진단 기록 → 드라이브)

“로그인·진단 기록 등을 재배포 후에도 안전하게, 실시간에 가깝게 백업”하는 방식입니다.

| 방식 | 설명 | 장점 | 단점 |
|------|------|------|------|
| **외부 DB 사용** | Render는 앱만, DB는 닷홈 MySQL 또는 관리형 DB | 재배포와 무관하게 데이터 유지, “백업”이 곧 DB 자체 | DB 서비스 비용·제한(닷홈은 원격 허용 여부 확인 필요) |
| **주기적 덤프 + 클라우드** | Cron 등으로 주기적(예: 매일) DB 덤프 후 Google Drive/Dropbox/S3 업로드 | 데이터 복구용 스냅샷 확보 | “실시간”은 아니고 스케줄 간격만큼 지연, 스크립트·권한 관리 필요 |
| **앱에서 저장 시 이중 기록** | 로그인·진단 저장 시 DB + 별도 스토리지(드라이브 API 등)에 동시 기록 | 이론상 실시간에 가까움 | 구현 복잡, API 할당량·에러 처리 부담 |

**실무적으로 가성비 좋은 조합**:
- **데이터 유지**: Render + **외부 DB 1곳**(닷홈 MySQL 또는 무료/저렴한 관리형 DB).
- **백업**: 그 외부 DB를 **주기적 덤프**해서 Google Drive 등에 저장 (실시간은 아니어도 “매일 백업”이면 대부분 충분).

---

## 5. 최적 대응 방안 비교 (가성비·안정성)

| 방안 | 데이터 유지 | 재배포 후 | 가성비 | 안정성 | 비고 |
|------|-------------|-----------|--------|--------|------|
| **Render + 닷홈 MySQL** | ✅ (DB가 닷홈에 있음) | ✅ 유지 | 높음 (기존 닷홈 사용) | 닷홈 원격 허용 시 가능, 호스팅 제한 확인 필요 | 연동 가능하면 가장 단순 |
| **Render + Render PostgreSQL** | ✅ | ✅ 유지 | 유료 | 높음 | Render와 같은 플랫폼, 백업 옵션 있음 |
| **Render + Supabase/Neon 등 무료 PostgreSQL** | ✅ | ✅ 유지 | 무료 티어 있음 | 높음 | MVP2 전환 시에도 재사용 용이 |
| **Render + SQLite (무료)** | ❌ | ❌ 재배포 시 초기화 | 무료 | 낮음 (데이터 유실 위험) | 테스트용만 권장 |
| **Render + SQLite + Persistent Disk** | ✅ | ✅ 유지 가능 | 유료 | 중간 (디스크 고장 시 백업 필요) | 백업 스크립트 별도 권장 |
| **주기 백업(덤프 → Drive 등)** | 스냅샷으로 보관 | 재배포 후 복구 가능 | 보통 | 중간 | 외부 DB와 병행 시 권장 |

**정리**:
- **가성비 + 안정성**을 함께 보려면:  
  **Render(앱) + 외부 DB 1곳(닷홈 MySQL 또는 Supabase 등 관리형 PostgreSQL)** 으로 재배포 시에도 데이터 유지 + **같은 DB를 주기적으로 덤프해서 드라이브에 백업**하는 구성이 적당합니다.
- **Render + Supabase** 전환 방법: [docs/Render_Plus_Supabase_배포_가이드.md](Render_Plus_Supabase_배포_가이드.md) 참고. (둘 다 무료 플랜 가능.)
- 닷홈 연동은 **닷홈 MySQL 원격 접속 허용 여부**에 따라 가능 여부가 갈립니다. 가능하면 기존 도메인(leejee5.dothome.co.kr)과 무관하게 **DB만** Render에서 접속해 쓰는 형태로 연동할 수 있습니다.

---

## 6. 닷홈(leejee5.dothome.co.kr) 연동과의 관계

- **웹 사이트 주소** (leejee5.dothome.co.kr) 와 **MySQL DB**는 별개입니다.
- **연동**이란: Render에서 **그 MySQL DB에 접속해 읽기/쓰기**하는 것을 말합니다.
- 도메인(leejee5.dothome.co.kr)을 Render로 옮기거나, 반대로 “닷홈 페이지에서 Render API 호출” 같은 것은 이 문서의 “데이터 유지”와는 별도 주제입니다.
- **데이터만** 닷홈 MySQL에 두고, Render는 “앱 서버 + 닷홈 DB 사용”으로 가면, 재배포·업그레이드 후에도 기존 데이터가 유지됩니다.

---

## 7. 권장 순서 (요약)

1. **닷홈 MySQL 원격 접속** 가능 여부 확인 (제어판·문의).
2. 가능하면: Render 환경 변수에 `DB_ENGINE=mysql`, `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME` 설정 → 재배포해도 데이터 유지.
3. 기존 SQLite(sbi.db) 데이터가 있으면: **한 번만** SQLite → MySQL 이전 스크립트 실행 후, 이후에는 Render가 MySQL만 사용하도록 설정.
4. **백업**: 같은 MySQL을 주기적으로 덤프해 Google Drive 등에 저장 (실시간 백업이 꼭 필요하면 그다음 단계로 “저장 시 이중 기록” 등을 검토).

이렇게 하면 재배포·업그레이드 후에도 기존 데이터가 유지되고, 닷홈 연동은 MySQL 원격 접속 가능 시 무리 없이 적용할 수 있습니다.
